<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Repositório de Aulas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />
  <style>
    /* Custom Global Styles */
    body {
      font-family: 'Roboto', sans-serif;

    }

    * {
      animation: fade-in 0.6s ease-out forwards;
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card-hover {
      transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    }

    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .slide-in {
      animation: slideIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.98);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Modal animations */
    .modal-content.modal-enter {
      opacity: 0;
      transform: scale(0.9) translateY(-20px);
      transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }

    .modal-content.modal-enter-active {
      opacity: 1;
      transform: scale(1) translateY(0);
    }

    .modal-content.modal-exit {
      opacity: 1;
      transform: scale(1) translateY(0);
      transition: opacity 0.3s ease-in, transform 0.3s ease-in;
    }

    .modal-content.modal-exit-active {
      opacity: 0;
      transform: scale(0.9) translateY(-20px);
    }

    /* Quill Editor Styling */
    .ql-toolbar {
      border-top-left-radius: 0.5rem;
      border-top-right-radius: 0.5rem;
      border-bottom: none;
    }

    .ql-container {
      border-bottom-left-radius: 0.5rem;
      border-bottom-right-radius: 0.5rem;
      border-top: none;
    }

    /* Section fade animations */
    .section-fade-in {
      animation: sectionFadeIn 0.3s ease-in forwards;
    }

    .section-fade-out {
      animation: sectionFadeOut 0.3s ease-out forwards;
    }

    @keyframes sectionFadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes sectionFadeOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }

      to {
        opacity: 0;
        transform: translateY(-10px);
      }
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">
  <header class="bg-blue-600 shadow-lg">
    <div class="container mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <span class="material-icons text-white text-2xl">school</span>
          <h1 class="text-white text-xl font-medium">Repositório de Aulas</h1>
        </div>
        <button id="backBtn"
          class="hidden text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all duration-200 flex items-center space-x-2">
          <span class="material-icons">arrow_back</span>
        </button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-6 py-8">
    <div id="turmasView" class="fade-in">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-light text-gray-800 mb-2">Selecione uma Turma</h2>
        <p class="text-gray-600">Escolha a turma para acessar o conteúdo das aulas</p>
      </div>
      <div id="turmasGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <div id="aulasView" class="hidden">
      <div class="flex justify-between items-center mb-8">
        <div>
          <h2 id="turmaNome" class="text-3xl font-light text-gray-800 mb-2"></h2>
          <p class="text-gray-600">Materiais de aula disponíveis</p>
        </div>
        <div class="flex flex-wrap justify-end space-x-4">
          <button id="showAulasBtn"
            class="px-4 py-2 m-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 hover:text-white   hover:scale-105 transition">
            Aulas
          </button>
          <button id="showAtividadesBtn"
            class="px-4 py-2 m-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 hover:text-white hover:scale-105 transition">
            Atividades
          </button>
        </div>
      </div>

      <!-- Aulas Section -->
      <div id="aulasSection">
        <div id="aulasGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </div>

      <!-- Atividades Section -->
      <div id="atividadesSection" class="hidden">
        <div id="atividadesList" class="space-y-6">
          <!-- Activities will be rendered here -->
        </div>
      </div>
    </div>
  </main>

  <!-- Activity Modal -->
  <div id="activityModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 md:p-2 ">
    <div class="bg-white w-full h-full flex flex-col modal-content rounded-xl">
      <!-- Header -->
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 z-10 flex-shrink-0 rounded">
        <div class="flex items-center justify-between">
          <h3 id="activityModalTitle" class="text-xl font-semibold text-gray-900"></h3>
          <button id="closeActivityModal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
            <span class="material-icons text-2xl">close</span>
          </button>
        </div>
      </div>

      <!-- Content -->
      <div class="p-6 overflow-y-auto grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1">
        <!-- Left Column -->
        <div class="h-full flex flex-col min-h-[350px] min-w-[280px]">
          <!-- Activity Content -->
          <div id="activityContent" class="rounded-lg flex-1 flex flex-col">

            <div id="activityContentFrame" class="w-full flex-1 min-h-[250px]  bg-white rounded-md overflow-hidden">
              <!-- Content will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <div class="h-full flex flex-col min-h-[350px] min-w-[260px] overflow-y-auto">
          <div class="bg-white p-2 rounded-xl shadow flex-1 flex flex-col mb-2">
            <h3 class="text-lg font-semibold text-gray-800 mb-1">Enviar Atividade</h3>
            <form id="atividadeForm" class="flex-1 flex flex-col space-y-3">
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-0">Seu Nome</label>
                <input type="text" id="alunoNome" name="from_name"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                  required>
              </div>
              <div class="flex-1 flex flex-col">
                <label class="block text-xs font-medium text-gray-600 mb-0">Respostas</label>
                <div id="editor" class="bg-white border border-gray-300 flex-1 min-h-[200px] rounded-md "></div>
                <input type="hidden" id="atividadeTexto" name="mensagem">
              </div>
              <div class="flex justify-end pt-1">
                <button type="submit"
                  class="px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 transition">Enviar</button>
              </div>
            </form>
          </div>
        </div>

      </div>
    </div>
  </div>


  <!-- Password Modal -->
  <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 mx-4 w-full max-w-md slide-in modal-content">
      <div class="text-center mb-6">
        <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
          <span class="material-icons text-blue-600 text-2xl">lock</span>
        </div>
        <h3 class="text-xl font-medium text-gray-800 mb-2">Acesso à Turma</h3>
        <p id="modalTurmaName" class="text-gray-600"></p>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
          <input type="password" id="passwordInput"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
            placeholder="Digite a senha da turma">
        </div>
        <div id="errorMessage" class="hidden text-red-600 text-sm flex items-center space-x-2">
          <span class="material-icons text-sm">error</span>
          <span>Senha incorreta. Tente novamente.</span>
        </div>
        <div class="flex space-x-3 pt-4">
          <button id="cancelBtn"
            class="flex-1 px-6 py-3 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200">Cancelar</button>
          <button id="confirmBtn"
            class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Entrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 mx-4 w-full max-w-md slide-in modal-content">
      <div class="text-center">
        <div class="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
          <span class="material-icons text-green-600 text-2xl">check_circle</span>
        </div>
        <h3 id="successModalTitle" class="text-xl font-medium text-gray-800 mb-2">Sucesso!</h3>
        <p id="successModalMessage" class="text-gray-600 mb-6">Operação concluída com sucesso!</p>
        <button id="successOkBtn" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">OK</button>
      </div>
    </div>
  </div>

  <!-- Error Modal -->
  <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 mx-4 w-full max-w-md slide-in modal-content">
      <div class="text-center">
        <div class="bg-red-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
          <span class="material-icons text-red-600 text-2xl">error</span>
        </div>
        <h3 class="text-xl font-medium text-gray-800 mb-2">Erro!</h3>
        <p id="errorModalMessage" class="text-gray-600 mb-6">Ocorreu um erro inesperado.</p>
        <button id="errorOkBtn" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700">OK</button>
      </div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 mx-4 w-full max-w-md modal-content">
      <div class="text-center">
        <div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
        <p class="text-gray-600">Enviando atividade...</p>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
  <script type="module">
    import {
      showSuccessModal,
      hideSuccessModal,
      showErrorModal,
      hideErrorModal,
      showLoadingModal,
      hideLoadingModal
    } from './global/alert-modals.js';
    import EmailSender from './global/mailer.js';

    let turmasData = {};
    let currentTurma = null;
    let currentActivityId = null;
    let quill = null;
    let emailSender = null;

    const turmasView = document.getElementById('turmasView');
    const aulasView = document.getElementById('aulasView');
    const turmasGrid = document.getElementById('turmasGrid');
    const aulasGrid = document.getElementById('aulasGrid');
    const atividadesList = document.getElementById('atividadesList');
    const backBtn = document.getElementById('backBtn');
    const turmaNome = document.getElementById('turmaNome');

    const passwordModal = document.getElementById('passwordModal');
    const passwordInput = document.getElementById('passwordInput');
    const cancelBtn = document.getElementById('cancelBtn');
    const confirmBtn = document.getElementById('confirmBtn');
    const errorMessage = document.getElementById('errorMessage');
    const modalTurmaName = document.getElementById('modalTurmaName');

    const activityModal = document.getElementById('activityModal');
    const closeActivityModalBtn = document.getElementById('closeActivityModal');
    const atividadeForm = document.getElementById('atividadeForm');

    const successOkBtn = document.getElementById('successOkBtn');
    const errorOkBtn = document.getElementById('errorOkBtn');

    function renderTurmas() {
      turmasGrid.innerHTML = '';
      Object.entries(turmasData).forEach(([id, turma]) => {
        const turmaCard = document.createElement('div');
        turmaCard.className = `${turma.cor} rounded-2xl p-6 text-white cursor-pointer card-hover`;
        turmaCard.innerHTML = `
          <div class="flex items-center justify-between mb-4">
            <span class="material-icons text-3xl">${turma.icone}</span>
            <span class="material-icons">arrow_forward</span>
          </div>
          <h3 class="text-xl font-medium mb-2">${turma.nome}</h3>
          <p class="text-white text-opacity-80">${Object.keys(turma.aulas || {}).length} aulas disponíveis</p>
        `;
        turmaCard.addEventListener('click', () => showPasswordModal(id, turma));
        turmasGrid.appendChild(turmaCard);
      });
    }

    function showPasswordModal(turmaId, turma) {
      currentTurma = turmaId;
      modalTurmaName.textContent = turma.nome;
      passwordModal.classList.remove('hidden');
      passwordModal.classList.add('flex');
      const modalContent = passwordModal.querySelector('.modal-content');
      modalContent.classList.add('modal-enter');
      setTimeout(() => modalContent.classList.add('modal-enter-active'), 10);
      passwordInput.focus(); errorMessage.classList.add('hidden'); passwordInput.value = '';
    }
    function hidePasswordModal() {
      const modalContent = passwordModal.querySelector('.modal-content');
      modalContent.classList.add('modal-exit');
      modalContent.classList.remove('modal-enter-active');
      setTimeout(() => {
        passwordModal.classList.add('hidden');
        passwordModal.classList.remove('flex');
        modalContent.classList.remove('modal-exit');
        currentTurma = null;
      }, 300);
    }
    function enterTurma() {
      const password = passwordInput.value;
      const turma = turmasData[currentTurma];
      if (password === turma.senha) {
        hidePasswordModal();
        showAulasView(currentTurma, turma);
      } else {
        errorMessage.classList.remove('hidden');
        passwordInput.classList.add('border-red-500');
        setTimeout(() => passwordInput.classList.remove('border-red-500'), 2000);
      }
    }

    function renderAulas(aulas) {
      aulasGrid.innerHTML = '';
      Object.entries(aulas).forEach(([tema, aula]) => {
        const aulaCard = document.createElement('div');
        aulaCard.className = 'bg-white rounded-2xl p-2 shadow-md cursor-pointer card-hover relative';
        aulaCard.innerHTML = `
         <div class="absolute top-0 left-0 transform -translate-x-1/4 -translate-y-1/4">
            <div class="bg-blue-100 p-3 rounded-full max-h-12 flex-shrink-0">
              <b class="text-blue-600">${aula.icone}</b>
            </div>
          </div>
          <div class="flex items-start justify-between p-4">
            <div class="px-4">
              <h3 class="text-lg font-medium text-gray-800">${tema}</h3>
              <p class="text-gray-600 text-sm">${aula.descricao}</p>
            </div>
            <span class="material-icons text-gray-400">open_in_new</span>
          </div>
          
        `;
        aulaCard.addEventListener('click', () => { window.open(aula.caminho, '_blank'); });
        aulasGrid.appendChild(aulaCard);
      });
    }

    function renderAtividades(atividades, turmaId) {
      const atividadesContainer = document.getElementById('atividadesList');
      atividadesContainer.innerHTML = '';
      atividadesContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
      if (!atividades || atividades.length === 0) {
        atividadesContainer.innerHTML = '<p class="text-gray-500 text-center py-4 col-span-full">Nenhuma atividade disponível no momento.</p>';
        return;
      }
      atividades.forEach((atividade) => {
        atividade.turmaId = turmaId;
        const card = document.createElement('div');
        card.className = 'bg-white rounded-2xl p-6 shadow-md cursor-pointer card-hover relative';
        card.onclick = () => showActivityModal(atividade);
        const icon = atividade.icone || 'assignment';
        card.innerHTML = `
          <div class="absolute top-0 left-0 transform -translate-x-1/2 -translate-y-1/4 ml-2">
            <div class="bg-blue-100 p-3 rounded-full max-h-12 flex-shrink-0">
              <b class=" text-blue-600">${icon}</b>
            </div>
          </div>
          <div class="flex items-start justify-between">
            <div class="flex flex-1">
                <div class="ml-2 flex-1">
                  <h3 class="text-lg font-medium text-gray-800">${atividade.titulo}</h3>
                  <p class="text-gray-600 text-sm">${atividade.descricao}</p>
              </div>
            <span class="material-icons text-gray-400">open_in_new</span>
          </div>

        `;
        atividadesContainer.appendChild(card);
      });
    }

    function showAulasView(turmaId, turma) {
      currentTurma = turmaId;
      turmasView.classList.add('hidden'); aulasView.classList.remove('hidden'); backBtn.classList.remove('hidden');
      turmaNome.textContent = turma.nome;
      renderAulas(turma.aulas);
      if (turma.atividades && turma.atividades.length > 0) {
        renderAtividades(turma.atividades, turmaId);
        document.getElementById('showAtividadesBtn').classList.remove('hidden');
      } else {
        atividadesList.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhuma atividade disponível no momento.</p>';
        document.getElementById('showAtividadesBtn').classList.add('hidden');
      }
      document.getElementById('aulasSection').classList.remove('hidden');
      document.getElementById('aulasSection').classList.add('section-fade-in');
      document.getElementById('atividadesSection').classList.add('hidden');
      document.getElementById('showAulasBtn').classList.add('bg-blue-600', 'text-white');
      document.getElementById('showAulasBtn').classList.remove('bg-gray-200', 'text-gray-700');
      document.getElementById('showAtividadesBtn').classList.add('bg-gray-200', 'text-gray-700');
      document.getElementById('showAtividadesBtn').classList.remove('bg-blue-600', 'text-white');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function goBackToTurmas() {
      aulasView.classList.add('hidden'); backBtn.classList.add('hidden');
      turmasView.classList.remove('hidden'); turmasView.classList.add('fade-in');
      closeActivityModal
    }

    function initializeQuill() {
      if (quill) return;
      quill = new Quill('#editor', {
        theme: 'snow',
        modules: { toolbar: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', 'strike'], [{ 'list': 'ordered' }, { 'list': 'bullet' }], ['link'], ['clean'], ['code-block']] },
        placeholder: 'Digite sua resposta aqui...',
      });
    }

    function showActivityModal(atividade) {
      // Definir a activity atual e garantir que a turma atual represente a origem da atividade
      currentActivityId = atividade.id;
      if (atividade.turmaId) currentTurma = atividade.turmaId;
      document.getElementById('alunoNome').value = localStorage.getItem('alunoNome') || '';
      document.getElementById('activityModalTitle').textContent = atividade.titulo;
      const frame = document.getElementById('activityContentFrame');
      if (atividade.caminho) {
        frame.innerHTML = `<iframe src="${atividade.caminho + "?nocache=" + Date.now()}" class="w-full h-full border-0 rounded-md"></iframe>`;
      } else {
        frame.innerHTML = `<div class="p-4 text-center text-gray-500 flex items-center justify-center h-full">Nenhum conteúdo de apoio para esta atividade.</div>`;
      }

      initializeQuill();
      const savedDraft = localStorage.getItem(`draft_${atividade.id}`);
      if (savedDraft) { quill.clipboard.dangerouslyPasteHTML(savedDraft); }
      else { quill.setContents([{ insert: '\n' }]); }
      quill.on('text-change', () => {
        const content = quill.root.innerHTML;
        if (content && content !== '<p><br></p>') localStorage.setItem(`draft_${atividade.id}`, content);
      });
      activityModal.classList.remove('hidden');
      activityModal.classList.add('flex');
      const modalContent = activityModal.querySelector('.modal-content');
      modalContent.classList.add('modal-enter');
      setTimeout(() => modalContent.classList.add('modal-enter-active'), 10);
    }

    function closeActivityModal() {
      const modalContent = activityModal.querySelector('.modal-content');
      modalContent.classList.add('modal-exit');
      modalContent.classList.remove('modal-enter-active');
      setTimeout(() => {
        activityModal.classList.add('hidden');
        activityModal.classList.remove('flex');
        modalContent.classList.remove('modal-exit');
        if (quill) { quill.off('text-change'); quill.root.innerHTML = ''; }
        atividadeForm.reset(); currentActivityId = null;
      }, 300);
    }

    function setupEventListeners() {
      backBtn.addEventListener('click', goBackToTurmas);
      passwordInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') enterTurma(); });
      cancelBtn.addEventListener('click', hidePasswordModal);
      confirmBtn.addEventListener('click', enterTurma);
      passwordModal.addEventListener('click', (e) => { if (e.target === passwordModal) hidePasswordModal(); });
      successOkBtn.addEventListener('click', hideSuccessModal);
      errorOkBtn.addEventListener('click', hideErrorModal);
      closeActivityModalBtn.addEventListener('click', closeActivityModal);
      activityModal.addEventListener('click', (e) => { if (e.target === activityModal) closeActivityModal(); });
      document.getElementById('alunoNome').addEventListener('input', (e) => { localStorage.setItem('alunoNome', e.target.value); });
      document.getElementById('showAulasBtn').addEventListener('click', function () {
        const aulasSection = document.getElementById('aulasSection');
        const atividadesSection = document.getElementById('atividadesSection');
        if (!atividadesSection.classList.contains('hidden')) {
          atividadesSection.classList.add('section-fade-out');
          setTimeout(() => {
            atividadesSection.classList.add('hidden');
            atividadesSection.classList.remove('section-fade-out');
            aulasSection.classList.remove('hidden');
            aulasSection.classList.add('section-fade-in');
          }, 300);
        } else {
          aulasSection.classList.remove('hidden');
          aulasSection.classList.add('section-fade-in');
        }
        this.classList.add('bg-blue-600', 'text-white');
        this.classList.remove('bg-gray-200', 'text-gray-700');
        const atividadesBtn = document.getElementById('showAtividadesBtn');
        atividadesBtn.classList.add('bg-gray-200', 'text-gray-700');
        atividadesBtn.classList.remove('bg-blue-600', 'text-white');
      });
      document.getElementById('showAtividadesBtn').addEventListener('click', function () {
        const aulasSection = document.getElementById('aulasSection');
        const atividadesSection = document.getElementById('atividadesSection');
        if (!aulasSection.classList.contains('hidden')) {
          aulasSection.classList.add('section-fade-out');
          setTimeout(() => {
            aulasSection.classList.add('hidden');
            aulasSection.classList.remove('section-fade-out');
            atividadesSection.classList.remove('hidden');
            atividadesSection.classList.add('section-fade-in');
          }, 300);
        } else {
          atividadesSection.classList.remove('hidden');
          atividadesSection.classList.add('section-fade-in');
        }
        this.classList.add('bg-blue-600', 'text-white');
        this.classList.remove('bg-gray-200', 'text-gray-700');
        const aulasBtn = document.getElementById('showAulasBtn');
        aulasBtn.classList.add('bg-gray-200', 'text-gray-700');
        aulasBtn.classList.remove('bg-blue-600', 'text-white');
      });

      atividadeForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        // Determina corretamente a atividade e a turma associada
        let turmaId = null;
        let atividade = null;

        // Primeiro tenta a turma atualmente selecionada
        if (currentTurma && turmasData[currentTurma] && turmasData[currentTurma].atividades) {
          atividade = turmasData[currentTurma].atividades.find(a => a.id === currentActivityId);
          if (atividade) turmaId = currentTurma;
        }

        // Se não encontrou, busca globalmente
        if (!atividade) {
          for (const [tid, turma] of Object.entries(turmasData)) {
            if (turma.atividades) {
              const found = turma.atividades.find(a => a.id === currentActivityId);
              if (found) { atividade = found; turmaId = tid; break; }
            }
          }
        }

        // Se a própria atividade tem turmaId atribuído (renderAtividades), prioriza isso
        if (atividade && atividade.turmaId) turmaId = atividade.turmaId;

        const turma = turmaId ? turmasData[turmaId] : null;
        if (!turma) { showErrorModal('Erro: Turma não encontrada.'); return; }
        if (!atividade) { showErrorModal('Erro: Não foi possível encontrar os dados da atividade.'); return; }

        const alunoNome = document.getElementById('alunoNome').value.trim();
        if (!alunoNome) { showErrorModal('Por favor, preencha seu nome.'); return; }
        if (!quill.getText().trim()) { showErrorModal('Por favor, escreva sua resposta antes de enviar.'); return; }
        const mensagem = quill.root.innerHTML;
        showLoadingModal();
        try {
          await emailSender.sendAtividadeEmail(
            "uzeda.dev@gmail.com", // Destinatário - será configurado no backend
            turma.nome,
            alunoNome,
            atividade.titulo,
            mensagem
          );
          localStorage.removeItem(`draft_${atividade.id}`);
          closeActivityModal(); showSuccessModal('Atividade enviada com sucesso!');
        } catch (error) { console.error('Erro ao enviar atividade:', error); showErrorModal(`Ocorreu um erro ao enviar a atividade: ${error.message || 'Erro desconhecido'}`); }
        finally { hideLoadingModal(); }
      });
    }

    async function main() {
      try {
        // Carrega configurações públicas (sempre versionadas no repo)
        const response = await fetch(`settings.json?nocache=${Date.now()}`, { cache: 'no-store' });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const settings = await response.json();
        // Monta turmasData automaticamente:
        // 1) copia settings.turmas (se houver)
        // 2) mescla quaisquer chaves top-level que pareçam ser turmas (objeto com nome + aulas)
        turmasData = {};
        if (settings.turmas && typeof settings.turmas === 'object') {
          Object.assign(turmasData, settings.turmas);
        }
        Object.entries(settings).forEach(([key, val]) => {
          if (key === 'turmas' || key === 'email' || key === 'logica' /*deprecated compat*/) return;
          if (val && typeof val === 'object' && val.nome && val.aulas) {
            if (!turmasData[key]) turmasData[key] = val;
          }
        });
        // Compat: ainda respeita settings.logica caso exista
        if (settings.logica && !turmasData['logica']) turmasData['logica'] = settings.logica;
        let emailConfig = settings.email || {};
        console.debug("🚀 ~ main ~ settings.email (public):", emailConfig);

        // Tenta carregar configurações secretas locais (não versionadas). Se existir,
        // mescla senhas das turmas e credenciais de e-mail.
        try {
          const secretResp = await fetch('secret.json');
          if (secretResp.ok) {
            const secrets = await secretResp.json();
            if (secrets.email) {
              // mescla credenciais de e-mail (service/template/key)
              emailConfig = Object.assign({}, emailConfig, secrets.email);
            }
            if (secrets.turmas) {
              Object.entries(secrets.turmas).forEach(([tid, tdata]) => {
                if (turmasData[tid]) turmasData[tid].senha = tdata.senha;
              });
            }
            console.debug('Loaded secret settings and merged into runtime config.');
          } else {
            console.info('No local secret settings found (secret.json) — continuing with public config only.');
          }
        } catch (err) {
          console.warn('Failed to load secret.json (this is OK for public deployments):', err);
        }

        // Inicializa o serviço de email usando API Rust (backend rodando no Docker)
        emailSender = new EmailSender();
        console.log('Email service initialized successfully.');

        renderTurmas(); setupEventListeners();
      } catch (error) {
        console.error('Erro ao carregar configurações:', error);
        showErrorModal('Falha ao carregar as configurações. Por favor, recarregue a página.');
      }
    }
    main();
  </script>
</body>

</html>